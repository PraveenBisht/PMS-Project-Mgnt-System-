<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>PMS</title>
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
    <!-- fav-icon image/png -->
    <link rel="icon" href="img/fav-icon.png" type="image/png" sizes="16x16">
    <!-- font-awesome/4.7.0 -->
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <!-- font-family: 'Roboto', sans-serif; -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,100i,300,300i,400,400i,500,500i,700,700i,900,900i&display=swap" rel="stylesheet">
    <!-- Custom bootstrap css for this website-->
    <link rel="stylesheet" href="~/Template/vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="~/Template/vendor/datatables/css/dataTables.bootstrap4.min.css">
    <link href="~/Content/ChatStyle.css" rel="stylesheet" />
    <link href="~/Scripts/datetimepicker/jqueryui.css" rel="stylesheet" />
    <link href="~/Content/toastr.css" rel="stylesheet" />
    <!-- mystyle and mymeida css for this website-->
    @Styles.Render("~/Content/Home_LayOutCss")
    @*<script src="~/Template/vendor/jquery/js/jquery.min.js"></script>*@
    <script src="~/Scripts/datetimepicker/jquery-1.12.4.js"></script>
    <script src="~/Scripts/datetimepicker/jqueryui.js"></script>
    <script src="~/Scripts/toastr.js"></script>

    <style>
 .sidenav-Box { 
    background-color: white;
}
    </style>
</head>
<body id="goto_Top">
    <div class="wrapper">
        <!-- / head-Box: start \ -->
        <div class="head-Box">
            <div class="container-fluid">
                <div class="head-Bar row">
                    <div class="head-list col-sm-6 col-2">
                        <div class="head-button">
                            <div class="toggle-button toggle_button">
                                <ul>
                                    <li><span class="toggle-button-span1">1</span></li>
                                    <li><span class="toggle-button-span2">2</span></li>
                                    <li><span class="toggle-button-span3">3</span></li>
                                </ul>
                            </div>
                        </div>


                    </div>
                    <div class="head-list col-sm-6 col-10">
                        <div class="head-login">
                            <ul>
                                <li><span class="fa-span"><i class="fa fa-envelope" aria-hidden="true"></i></span><a href="javascript:void(0);" id="username"></a></li>
                                <div class="head-line">
                                    <span class="head-line-span"></span>
                                </div>
                                <li><span class="fa-span"><i class="fa fa-sign-out" aria-hidden="true"></i></span><a href="javascript:void(0);" data-toggle="modal" data-target="#logoutModal">Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- \ head-Box: end / -->
        <!-- / sidenav-Box: start \ -->
        <div class="sidenav-Box" style="">
            <div class="dlogo-Bar">
                <div class="dlogo-left">
                    <a class="dlogo-link" href="javascript:void(0);" title="P.M.S">PMS</a>
                </div>
                <div class="dlogo-right">
                    <div class="toggle-button toggle_button">
                        <ul>
                            <li><span class="toggle-button-span1">1</span></li>
                            <li><span class="toggle-button-span2">2</span></li>
                            <li><span class="toggle-button-span3">3</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="sidenav-Bar-Chat" id="sidenav_Bar">
                <h2>Chat</h2>
                <ul class="scroll-chat-box" id="divusers"></ul>


            </div>
        </div>
        <!-- \ sidenav-Box: end / -->
        <!-- / main-wrapper: start \ -->
        <div class="main-wrapper">
            <div class="main-part px-xl-3 px-lg-0">
                <div class="loading"></div>
                <div id="PrivatChat">

                </div>
                @RenderBody()

            </div>
        </div>
     
      
    </div>

    <!--Reference the SignalR library. -->
    <script src="/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="/signalr/hubs"></script>
    <script type="text/javascript">

        $(function () {
            clearInterval(refreshId);


            // Declare a proxy to reference the hub.
            var chatHub = $.connection.chatHub;

                function setTotalNotification(totalNotif) {

                $("#messages").html("<p> Total Notif:" + totalNotif + "</p>");
            }

            chatHub.client.broadcaastNotif = function (totalNotif) {
                setTotalNotification(totalNotif)
            };


            $.connection.hub.logging = true;

            registerClientMethods(chatHub);

            // Start Hub
            $.connection.hub.start().done(function () {

                registerEvents(chatHub)
            });
        });

        // ------------------------------------------------------------------Variable ----------------------------------------------------------------------//
        var loadMesgCount = 10;
        var topPosition = 0;
        var refreshId = null;

        function scrollTop(ctrId) {
            var height = $('#SelectedUser').find('#divMessage')[0].scrollHeight;
            $('#SelectedUser').find('#divMessage').scrollTop(height);
        }

        // ------------------------------------------------------------------Start All Chat ----------------------------------------------------------------------//
            var EmailId= "@Session["EmailId"]";
             var Name = "@Session["Name"]";
        function registerEvents(chatHub) {
       
            chatHub.server.connect(Name, EmailId);

        }

        function registerClientMethods(chatHub) {
            // Calls when user successfully logged in
         chatHub.client.Connect = function (id, userName, allUsers) {
            $('#hdId').val(id);
            $('#hdUserName').val(userName);
            $('#spanUser').html(userName);
            // Add All Users
            for (i = 0; i < allUsers.length; i++) {
                console.log(allUsers.length);
              
                    AddUser(chatHub, allUsers[i].userId, allUsers[i].Name, allUsers[i].EmailID, allUsers[i].Picture, allUsers[i].OnlineStatus, allUsers[i].InComingmessagecount);
                
                if (i == 1) {
                       var UserEmail = "@Session["EmailId"]";
                         OpenPrivateChatWindow(chatHub, allUsers[i].userId, allUsers[i].Name, UserEmail, allUsers[i].EmailID);
                }
            }

            }

            // On New User Connected
            chatHub.client.onNewUserConnect = function (id, name, email,picture,OnlineStatus) {

                AddNewUser(chatHub, id, name, email,picture,OnlineStatus);

            }

            // On User Disconnected
            chatHub.client.onUserDisconnected = function (id, userName,EmailID) {
                $('#' + EmailID).remove();

                var ctrId = 'private_' + EmailID;
                $('#' + ctrId).remove();
                z
                var disc = $('<div class="disconnect">"' + userName + '" logged off.</div>');

                $(disc).hide();
                $('#divusers').append(disc);

            }

            // On User Disconnected Existing
            chatHub.client.onUserDisconnectedExisting = function (id, userName) {
                $('#' + userName).remove();
                var ctrId = 'private_' + userName;
                $('#' + ctrId).remove();      
            }

            chatHub.client.messageReceived = function (userName, message) {
                AddMessage(userName, message);
            }


                chatHub.client.sendPrivateMessage = function (windowId, fromUserName, message, userEmail, email, status, fromUserId) {
                var ctrId = "SelectedUser";
                if (status == 'Click') {
                    if ($('#' + ctrId).length == 0) {
                        //createPrivateChatWindow(chatHub, windowId, ctrId, fromUserName, userEmail, email);

                        chatHub.server.getPrivateMessage(userEmail, email, loadMesgCount).done(function (msg) {
                            for (i = 0; i < msg.length; i++) {
                                $('#' + ctrId).find('#divMessage').append('<div class="message"><span class="userName">' + msg[i].userName + '</span>: ' + msg[i].message + '</div>');
                                // set scrollbar
                                scrollTop(ctrId);
                            }
                        });
                    }
                    else {
                        $('#' + ctrId).find('#divMessage').append('<div class="message"><span class="userName">' + fromUserName + '</span>: ' + message + '</div>');
                        // set scrollbar
                        scrollTop(ctrId);
                    }
                }

                if (status == 'Type') {
                    if (fromUserId == windowId)
                        $('#' + ctrId).find('#msgTypeingName').text('typing...');
                }
                else { $('#' + ctrId).find('#msgTypeingName').text(''); }
            }
        }

                 // Add User
            function AddUser(chatHub, id, name, email, ProfilePic, OnlineStatus, InComingmessagecount) {

            var userEmail = $('#hdEmailID').val();
            var code = "";
            if (userEmail == email && $('.loginUser').length == 0) {

            code = $('<div class="loginUser">' + name + "</div>");
            }
            else {
            if (OnlineStatus=='Online') {

            code = $('<li></li>').prepend('<a id="'+email+ '" >' + '<span style="height:8px;width:8px;background-color: green;border-radius: 50%;display: inline-block;"></span> &nbsp' + name + '<a>');
                    }
                    else
                    {
                    code = $('<li></li>').prepend('<a id="' + email + '"  >' + '<span style="height:8px;width:8px;background-color: red;border-radius: 50%;display: inline-block;"></span> &nbsp' + name + '<a>');

                   }
           
                            $(code).click(function () {
                            var id = $(this).attr('id');
                            if (userEmail != email) {
                                  $('#SelectedUser').remove();
                            OpenPrivateChatWindow(chatHub, id, name, userEmail, email);
                            }
                            });
                   }

                            $("#divusers").append(code);
                            $('.loading').hide();
                }


                       // Add User
            function AddNewUser(chatHub, id, name, email, ProfilePic, OnlineStatus, InComingmessagecount) {

            if (OnlineStatus=='Online') {

            code = $('<li></li>').prepend('<a id="'+email+ '" >' + '<span style="height:8px;width:8px;background-color: green;border-radius: 50%;display: inline-block;"></span> &nbsp' + name + '<a>');
                    }
                    else
                    {
                    code = $('<li></li>').prepend('<a id="' + email + '"  >' + '<span style="height:8px;width:8px;background-color: red;border-radius: 50%;display: inline-block;"></span> &nbsp' + name + '<a>');

                   }
           
                         

                $("#divusers").prepend(code);
                       
                }

        // ------------------------------------------------------------------End All Chat ----------------------------------------------------------------------//


        // ------------------------------------------------------------------Start Private Chat ----------------------------------------------------------------------//
        function OpenPrivateChatWindow(chatHub, id, userName, userEmail, email) {
            var ctrId =email;
            if (ctrId =="") return;

            createPrivateChatWindow(chatHub, id, ctrId, userName, userEmail, email);

                var UserEmail = "@Session["EmailId"]";
                var Sender_ConnectionId =UserEmail;
                var send_connectionID =  localStorage.getItem("ToSendUserId");
            chatHub.server.getPrivateMessage(Sender_ConnectionId, send_connectionID, 100).done(function (msg) {

                for (i = 0; i < msg.length; i++) {
                   
                    if (msg[i].MasterEmailID == UserEmail) {
                        $('#SelectedUser').find('#divMessage').append('<div class="message" "><span class="userName" >' + msg[i].userName + '</span>: ' + msg[i].message + '</div>');
                    }
                    else {
                         $('#SelectedUser').find('#divMessage').append('<div class="Usermessage" ><span class="userName">' + msg[i].userName + '</span>: ' + msg[i].message + '</div>');
                    }

                    // set scrollbar
                    scrollTop(ctrId);
                }
            });
        }

        function createPrivateChatWindow(chatHub, userId, ctrId, userName, userEmail, email) {
            localStorage.setItem("ToSendUserId",ctrId);
            var div = '<div id="SelectedUser" rel="0" style="width:100%;height:390px;position: fixed;" >' + ctrId +
                '<div class="header">' +
                '<div  style="float:right;">'  +
                '</div>' +
                '<span class="selText" rel="0">' + userName + '</span>' +
                '<span class="selText" id="msgTypeingName" rel="0"></span>' +
                '</div>' +
                '<div id="divMessage" class="messageArea">' +

                '</div>' +
                '<div class="buttonBar">' +'<textarea id="txtPrivateMessage" rows="2" cols="120" placeholder="Type message.."/>'+

                '<input id="btnSendMessage" class="submitButton button" type="button" value="Send" hidden="true"  />' +
                '</div>' +
                '<div id="scrollLength"></div>' +
                '</div>';

            var $div = $(div);

            // ------------------------------------------------------------------ Scroll Load Data ----------------------------------------------------------------------//

            var scrollLength = 2;
            $div.find('.messageArea').scroll(function () {
                      var UserEmail = "@Session["EmailId"]";
                      var Sender_ConnectionId =UserEmail;
                      var send_connectionID = localStorage.getItem("ToSendUserId");

                if ($(this).scrollTop() == 0) {
                    if ($('#SelectedUser').find('#scrollLength').val() != '') {
                        var c = parseInt($('#SelectedUser').find('#scrollLength').val(), 10);
                        scrollLength = c + 1;
                    }
                    $('#SelectedUser').find('#scrollLength').val(scrollLength);
                    var count = $('#SelectedUser').find('#scrollLength').val();

                
                    chatHub.server.getScrollingChatData(Sender_ConnectionId, send_connectionID, loadMesgCount, count).done(function (msg) {
                        for (i = 0; i < msg.length; i++) {
                            var firstMsg = $('#SelectedUser').find('#divMessage').find('.message:first');

                            // Where the page is currently:
                            var curOffset = firstMsg.offset().top - $('#SelectedUser').find('#divMessage').scrollTop();
                                   if (msg[i].userName == Name) {
                        $('#SelectedUser').find('#divMessage').prepend('<div class="message" "><span class="userName" >' + msg[i].userName + '</span>: ' + msg[i].message + '</div>');
                    }
                    else {
                         $('#SelectedUser').find('#divMessage').prepend('<div class="Usermessage" ><span class="userName">' + msg[i].userName + '</span>: ' + msg[i].message + '</div>');
                    }

                            $('#SelectedUser').find('#divMessage').scrollTop(firstMsg.offset().top - curOffset);
                        }
                    });
                }
            });

            // DELETE BUTTON IMAGE
            $div.find('#imgDelete').click(function () {
                $('#SelectedUser').remove();
            });

            // Send Button event
            $div.find("#btnSendMessage").click(function () {
                var UserEmail = "@Session["EmailId"]";
                $textBox = $div.find("#txtPrivateMessage");
                var Sender_ConnectionId = UserEmail;
                var send_connectionID = localStorage.getItem("ToSendUserId");
                var msg = $textBox.val();
                if (msg.length > 0) {
                    chatHub.server.sendPrivateMessage(msg,send_connectionID,Sender_ConnectionId, 'Click');
                    //Write Me
                    //start
                      var Notification = { UserID: userId, Message: msg };
                   $.ajax({
                   type: "POST",
                  url: "/api/ChatApi/SendNotification",
                  data: JSON.stringify(Notification),
                  contentType: 'application/json; charset=utf-8',
                  success: function (data) {
                    //reset field
                    $("#myMessage").val("");
                   },
                   error: function () {
                    alert("Error occured!!")
                  }
                  });
                    //End
                    $textBox.val('');
                }
            });

            // Text Box event
            $div.find("#txtPrivateMessage").keyup(function (e) {
                if (e.which == 13) {
                    $div.find("#btnSendMessage").click();
                }

                // Typing
                $textBox = $div.find("#txtPrivateMessage");
                  var UserEmail = "@Session["EmailId"]";
                var Sender_ConnectionId = UserEmail;
                var send_connectionID = localStorage.getItem("ToSendUserId");
                var msg = $textBox.val();
                if (msg.length > 0) {

                       chatHub.server.sendPrivateMessage(msg,send_connectionID,Sender_ConnectionId, 'Type');
                }
                else {
                
                     chatHub.server.sendPrivateMessage(msg,send_connectionID,Sender_ConnectionId, 'Empty');
                }

                clearInterval(refreshId);
                checkTyping(chatHub, Sender_ConnectionId, msg, $div, 5000);
            });

            AddDivToContainer($div);
        }

        function checkTyping(chatHub, userId, msg, $div, time) {
            refreshId = setInterval(function () {
                // Typing
                      var UserEmail = "@Session["EmailId"]";
                var Sender_ConnectionId = UserEmail;
                var send_connectionID = localStorage.getItem("ToSendUserId");
                $textBox = $div.find("#txtPrivateMessage");
                var msg = $textBox.val();
                if (msg.length == 0) {
                     chatHub.server.sendPrivateMessage(msg,send_connectionID,Sender_ConnectionId, 'Empty');
                   
                }
            }, time);
        }

        function AddDivToContainer($div) {
            $('#PrivatChat').prepend($div);


           
        }

    </script>

    <!-- jQuery.min.js first, then Bootstrap.min.jS -->

    <script src="~/Template/vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="~/Template/vendor/datatables/js/jquery.dataTables.min.js"></script>
    <script src="~/Template/vendor/datatables/js/dataTables.bootstrap4.min.js"></script>
    <script src="~/Template/vendor/fancybox/js/jquery.fancybox.min.js"></script>
    <!-- JavaScript File -->
    <script src="~/Scripts/js/myscript.js"></script>


</body>
</html>






